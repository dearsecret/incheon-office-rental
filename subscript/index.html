<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>카카오 로그인 처리</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; text-align: center; }
    #message { margin-top: 1.5rem; font-size: 1.2rem; }
  </style>
</head>
<body>
  <h1>카카오 로그인 중...</h1>
  <div id="message">잠시만 기다려 주세요.</div>

  <script>
    (async function() {
      const clientId = "44c5a278a01141a3be48d078ce631e02";
      const redirectUri = "https://song-do.com/subscript/";
      const gasUrl = "https://script.google.com/macros/s/AKfycbyVIEC7sfYi0lRwdYDcOOQ6vtz6b_z-p5qjz7KK4NUgCzkM3JpN9Snsz-yWpGa3QP7x/exec"; 

      function getUrlParams() {
        const params = {};
        location.search.substring(1).split("&").forEach(pair => {
          const [key, value] = pair.split("=");
          if (key) params[decodeURIComponent(key)] = decodeURIComponent(value || "");
        });
        return params;
      }

      function generateState() {
        if (crypto && crypto.randomUUID) {
          return crypto.randomUUID();
        }
        return Math.random().toString(36).substring(2) + Date.now().toString(36);
      }

      function getKakaoAuthUrl(state) {
        const baseUrl = "https://kauth.kakao.com/oauth/authorize";
        const params = new URLSearchParams({
          response_type: "code",
          client_id: clientId,
          redirect_uri: redirectUri,
          state: state,
          scope: "account_email talk_message"
        });
        return `${baseUrl}?${params.toString()}`;
      }

      function setMessage(text) {
        document.getElementById("message").textContent = text;
      }

      const params = getUrlParams();

      if (!params.code || !params.state) {
        const newState = generateState();
        localStorage.setItem("oauth_state", newState);
        await fetch(gasUrl, {
          method: "POST",
          redirect: "follow", // 꼭 포함
          body: JSON.stringify({ action: "registerState", state: newState }),
          headers: { "Content-Type": "text/plain;charset=utf-8" }, // 여기서 text/plain으로 설정해야 preflight 안 뜸
        });


        const kakaoLoginUrl = getKakaoAuthUrl(newState);
        window.location.href = kakaoLoginUrl;
        return;
      }
      const savedState = localStorage.getItem("oauth_state");
      if (!savedState || savedState !== params.state) {
        setMessage("잘못된 state 값입니다. 로그인 중단.");
        return;
      }

      try {
        setMessage("로그인 처리 중입니다...");
        const resp = await fetch(`${gasUrl}?code=${encodeURIComponent(params.code)}&state=${encodeURIComponent(params.state)}`, {
          method: "GET",
          redirect: "follow", // 기본값이지만 명확히 써주면 좋음
          headers: { "Accept": "application/json" }
        });

        const data = await resp.json();

        if (data.error) {
          setMessage("로그인 실패: " + data.error);
          console.error("오류 상세:", data);
        } else {
          setMessage("로그인 성공! 환영합니다.");
          console.log("성공 데이터:", data);
        }

      } catch (e) {
        setMessage("로그인 처리 중 오류가 발생했습니다.");
        console.error(e);
      }

    })();
  </script>
</body>
</html>